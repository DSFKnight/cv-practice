# Практическая работа №2. Детектирование объектов на изображениях с использованием библиотеки OpenCV

## Описание программы и её структура

Разработано консольное приложение для детектирования объектов с использованием обученной нейронной сети YOLOv3.

Программа состоит из класса **Detector**. Поля класса:

- ```args``` - аргументы командной строки;
- ```paths``` - пути файлов, указанных в качестве аргументов.

Методы класса:
- ```__init__(self, args)``` - метод инициализирует объект класса Detector с аргументами командной строки;
- ```make_paths(self, args)``` - метод создает словарь путей к файлам на основе аргументов командной строки;
- ```load_model(self)``` - метод загружает модель нейронной сети и возвращает сеть и имена выходных слоёв;
- ```load_classes(self)``` - метод загружает классы объектов из файла;
- ```detect_objects(self, image, net, classes, layers, colors)``` - метод выполняет обнаружение объектов на изображении с использованием загруженной модели;
- ```draw_rectangles(self, image, classes, colors, class_ids, probabilities, boxes)``` - метод рисует ограничивающие прямоугольники и метки на изображении для обнаруженных объектов;
- ```process_image(self, net, classes, layers, colors)``` - метод обрабатывает изображение и сохраняет (а также возможно отображает) результат.
- ```process_video(self, net, classes, layers, colors)``` - метод обрабатывает видео и сохраняет (а также возможно отображает) результат;
- ```run(self)``` - метод запускает процесс обнаружения объектов на изображении или видео.

Также в программе есть функция ```main()``` - основная функция программы.

## Описание методов
### 1. Метод загрузки модели нейронной сети
В этой функции происходит загрузка модели нейронной сети с помощью cv.dnn.readNet, в параметрах передаются пути к файлам весов и конфигурации. Далее в переменные записываются имена всех слоёв сети и выходные слои, которые не связаны с другими слоями. Метод возвращает сеть и список выходных слоёв.

### 2. Метод загрузки классов объектов из файла.
В этом методе программа открывает файл классов по указанному пути, после чего читает все строки из файла, удаляя пробелы. Функция возвращает список классов.

### 3. Метод обнаружения объектов на изображении
Данный метод принимает изображение, сеть, классы, выходные слои и цвета. Программа получает размеры изображения (высоту и ширину) и сохраняет их в новые переменные. Далее происходит преобразование изображения в блоб, т.е. изображение изменяется в тот вид, в котором с ним может работать нейронная сеть. Блоб устанавливается в качестве входных данных для сети. После этого происходит прямое распространение через сеть. Далее программа обрабатывает выходные данные для получения идентификаторов классов, вероятностей и координат ограничивающих прямоугольников (его размеры и верхний левый угол прямоугольника). Функция возвращает идентификаторы классов, вероятности и координаты ограничивающих прямоугольников.

### 4. Метод отображения прямоугольников и меток на изображении
Данная функция принимает изображение, классы, цвета, идентификаторы классов, вероятности и координаты ограничивающих прямоугольников. Программа выполняет подавление немаксимумов (NMS) для удаления перекрывающихся прямоугольников. Далее происходит отрисовка ограничивающих прямоугольников и меток на изображении для каждого обнаруженного объекта и подсчёт объектов каждого класса. Метод возвращает изображение с нарисованными прямоугольниками и словарь с числом объектов каждого класса.

### 5. Метод обработки и сохранения изображения
Данный метод принимает сеть, классы, выходные слои и цвета. Сначала происходит загрузка изображения по указанному пути. После этого программа вызывает методы, которые выполняют обнаружение объектов на изображении и отрисовку ограничивающих прямоугольников и меток. Также в консоль выводится количество обнаруженных объектов каждого класса. Программа сохраняет изображение в файл, если указан путь выходного файла. Изображение отображается в новом окне, если в консоли указан соответствующий флаг.

### 6. Метод обработки и сохранения видео
Данная функция принимает сеть, классы, выходные слои и цвета. Программа открывает видеофайл по указанному пути и получает размеры кадров (ширину и высоту) и частоту кадров видео. Затем создается объект VideoWriter для записи выходного видео, если указан путь выходного файла. После этого начинается бесконечный цикл, в котором выполняется чтение каждого кадра видео и вызываются методы, выполняющие обнаружение объектов на изображении и отрисовывающие ограничивающие прямоугольники и метки. Кроме того, в консоль выводится количество обнаруженных объектов каждого класса для каждого кадра. Программа записывает обработанные кадры в выходной видеофайл, если указан путь выходного файла. Кадры видео отображаются в новом окне, если в консоли указан соответствующий флаг. После завершения обработки освобождаются ресурсы видеозахвата и записывающего объекта.

### 7. Метод запуска процесса обнаружения объектов на изображении или видео.
В этом методе программа загружает модель и классы, генерирует случайные цвета для каждого класса, вызывает метод ```process_image``` или ```process_video``` (в зависимости от расширения исходного файла (.jpg или .mp4)) и возвращает 0 (в случае успешного выполнения) или 1 (если формат файла не поддерживается).

## Описание команд
Для того, чтобы запустить программу детектирования объектов, в командной строке необходимо указать следующую команду:
```
python cv_lab2.py -s <путь к изображению/видео> -w <путь к файлу весов> -cfg <путь к файлу конфигураций> -cl <путь к файлу классов> -o <название выходного изображения/видео> -v -c <доверительный порог> -n <порог немаксимума>
```

### Описание аргументов
В командной строке можно использовать следующие аргументы:

- `-s` или `--source`: предназначен для передачи пути к входному изображению/видео. Является необходимым параметром при запуске программы.
- `-w` или `--weight`: предназначен для передачи пути к файлу весов. Является необходимым параметром при запуске программы.
- `-cfg` или `--config`: предназначен для передачи пути к файлу конфигураций. Является необходимым параметром при запуске программы.
- `-cl` или `--classes`: предназначен для передачи пути к файлу классов. Является необходимым параметром при запуске программы.
- `-c` или `--confidence`: предназначен для хранения доверительного порога. Тип аргумента: `float`. Параметр необязательный. Имеет значение по умолчанию `0.5`.
- `-n` или `--nms`: предназначен для хранения порога немаксимума. Тип аргумента: `float`. Параметр необязательный. Имеет значение по умолчанию `0.4`.
- `-o` или `--output`: предназначен для хранения названия выходного изображения. Параметр необязательный.
- `-v` или `--view`: является флагом, который при объявлении подразумевает отображение изображения/кадров видео. Параметр необязательный.

### Пример использования аргументов
Пример команды для запуска программы для изображения:

```python cv_lab2.py -s "image/input2.jpg" -w "yolo/yolov3.weights" -cfg "yolo/yolov3.cfg" -cl "yolo/coco.names" -o "output/out_img.jpg" -v -c 0.7```

Пример команды для запуска программы для видео:

```python cv_lab2.py -s "video/video.mp4" -w "yolo/yolov3.weights" -cfg "yolo/yolov3.cfg" -cl "yolo/coco.names" -o "output/out_video" -v -c 0.7```
