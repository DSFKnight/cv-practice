# Практическая работа №3. Классификация изображений с использованием библиотеки OpenCV

## Описание программы и её структура

Разработано консольное приложение для классификации изображений.

Программа состоит из класса **ImageClassifier**. Поля класса:

- ```image_size``` - размер изображений, к которому они будут изменены;

- ```k``` - количество кластеров для алгоритма K-means;

- ```random_state``` - значение для инициализации генератора случайных чисел;

- ```detector``` - детектор ключевых точек (используется SIFT);

- ```descriptor``` - дескриптор ключевых точек (используется SIFT);

- ```kmeans``` - модель K-means для кластеризации дескрипторов;

- ```scaler``` - масштабирование признаков;

- ```X_test_features``` - признаки тестового набора данных после преобразования;

- ```clf``` - классификатор (SVC с RBF ядром).

Эти поля инициализируются в конструкторе класса ```__init__```.

Методы класса:

- ```__init__(self, k=100, image_size=(256, 256), random_state=21)``` - конструктор класса, инициализирует поля класса;

- ```load_images_from_folder(self, folder, label)``` - метод, который загружает изображения из указанной папки и присваивает им метку.

- ```prepare_data(self, train_folder, test_folder, first_class_name, second_class_name)``` - метод, который подготавливает данные для обучения и тестирования, загружая изображения из тренировочной и тестовой папок;

- ```extract_descriptors(self, images)``` - метод, извлекающий дескрипторы из изображений;

- ```build_feature_vectors(self, descriptors_list)``` - метод, который строит векторы признаков на основе дескрипторов;

- ```train(self, X_train, y_train)``` - метод, обучающий модель на тренировочных данных;

- ```evaluate(self, X_test, y_test)``` - метод, который оценивает модель на тестовых данных и выводит точность и отчёт о классификации;

- ```plot_classification_histogram(self, y_train_true, y_train_pred, y_test_true, y_test_pred)``` - метод, который строит гистограмму точности классификации для тренировочной и тестовой выборок;

- ```visualize_features(self, images, number=3)``` - метод, визуализирующий SIFT-дескрипторы для нескольких изображений;

- ```plot_confusion_matrix(self, y_train_true, y_train_pred, y_test_true, y_test_pred)``` - метод, который строит матрицы ошибок для тренировочной и тестовой выборок;

- ```visualize_results(self, X_train, y_train, y_train_pred, X_test, y_test, y_test_pred)``` - метод, визуализирующий результаты классификации, включая гистограмму точности, дескрипторы и матрицы ошибок.

Также в программе есть функция ```main()``` - основная функция программы.

## Описание методов
### 1. Метод загрузки изображений
В этой функции происходит загрузка изображения из указанной папки и присвоение им метки. Далее в переменные записываются имена всех слоёв сети и выходные слои, которые не связаны с другими слоями. Метод возвращает сеть и список выходных слоёв. Сначала создаются пустые списки для изображений и меток. Далее программа проходит по всем файлам в указанной папке, считывает каждое изображение и изменяет его размер до image_size (256x256) (если оно существует). После этого изображение и метка добавляются в соответствующие списки.

### 2. Метод подготовки данных
В этом методе данные подготавливаются для обучения и тестирования. Изначально загружаются изображения кошек и собак из тренировочной и тестовой папок для двух классов (о - класс кошек, 1 - класс собак). Далее программа объединяет изображения и метки для тренировочной и тестовой выборок. После этого данные перемешиваются, обеспечивая таким образом их случайность.

### 3. Метод извлечения дескрипторов
Данная функция извлекает дескрипторы из изображений. Сначала создаётся пустой список дескрипторов. После этого программа проходит по каждому изображению и преобразует их в оттенки серого. Далее происходит извлечение ключевых точек и дескрипторов с помощью SIFT. Затем дескрипторы добавляются в список.

### 4. Метод построения векторов признаков
Данный метод строит векторы признаков на основе дескрипторов. Сначала создаётся пустой список признаков. Далее программа проходит по каждому набору дескрипторов. Здесь происходит инициализация гистограммы нулями, затем программа предсказывает кластеры для каждого дескриптора, увеличивает значение в гистограмме для соответствующего кластера и добавляет гистограмму в список признаков.

### 5. Метод обучения модели
Данный метод обучает модель на тренировочных данных. Изначально из тренировочных изображений извлекаются дескрипторы. Затем все дескрипторы объединяются в один массив. После этого модель K-means обучается на извлечённых дескрипторах. Далее для тренировочных данных строятся векторы признаков, после чего признаки масштабируются. Затем происходит обучение классификатора SVC на тренировочных данных.

### 6. Метод, оценивающий модель на тестовых данных.
Данная функция оценивает модель на тестовых данных и выводит точность и отчёт о классификации. Изначально из тестовых изображений извлекаются дескрипторы. Далее для тестовых данных строятся векторы признаков, после чего признаки масштабируются. Затем программа предсказывает метки для тестовых данных, вычисляет точность и выводит отчёт о классификации.

### 7. Метод отображения гистограммы точности.
В этом методе строится гистограмма точности классификации для тренировочной и тестовой выборок. Программа вычисляет матрицы ошибок для тренировочной и тестовой выборок. Затем она вычисляет точность для каждой категории. На основе полученных вычислениях строится гистограмма точности для тренировочной и тестовой выборок.

### 8. Метод визуализации дескрипторов
В этом методе для нескольких изображений визуализируются дескрипторы. Сначала программа ограничивает количество изображений для отображения, это делается для того, чтобы введённое число не оказалось больше, чем число изображений. После создаётся фигура с подграфиками. Каждое изображение преобразуется в изображение в оттенках серого. Из изображения извлекаются ключевые точки, которые затем рисуются на изображении. После этого программа отображает оригинальное изображение и изображение с дескрипторами.

### 9. Метод построения матрицы ошибок
В данной функции происходит построение матрицы ошибок для тренировочной и тестовой выборок. Программа вычисляет матрицы ошибок для тренировочной и тестовой выборок, затем визуализирует матрицы ошибок с помощью ConfusionMatrixDisplay.

### 10. Метод визуализации результатов классификации
В этой функции визуализируются результаты классификации. Программа последовательно вызывает методы 7, 8 и 9.

## Описание команд
Для того, чтобы запустить программу, в командной строке необходимо указать следующую команду:
```
python cv_lab3.py -tr <путь к тренировочным данным> -te <путь к тестовым данным> -cn1 <название первого класса> -cn2 <название второго класса> -k <число кластеров> -in <число изображений>
```

### Описание аргументов
В командной строке можно использовать следующие аргументы:

- `-tr` или `--train`: указывает путь к папке, содержащей тренировочные изображения. Является необходимым параметром при запуске программы.
- `-te` или `--test`: указывает путь к папке, содержащей тестовые изображения. Является необходимым параметром при запуске программы.
- `-cn1` или `--first_class_name`: указывает имя первого класса, который будет использоваться для классификации. Является необходимым параметром при запуске программы.
- `-cn2` или `--second_class_name`: указывает имя второго класса, который будет использоваться для классификации. Является необходимым параметром при запуске программы.
- `-k` или `--clusters`: указывает количество кластеров, которые будут использоваться в алгоритме K-means для кластеризации дескрипторов. Параметр необязательный.
- `-in` или `--image_number`: указывает число изображений, которые отобразятся в оригинале и с дескрипторами. Тип аргумента: `int`. Параметр необязательный. Имеет значение по умолчанию `3`.

### Пример использования аргументов
Пример команды для запуска программы:

```python cv_lab3.py -tr data/train -te data/test -cn1 cats -cn2 dogs -k 50 -in 3```
